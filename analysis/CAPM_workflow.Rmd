---
title: "Workflow: Capital Asset Pricing Model for Ecological Portfolios"
output:
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: true
---

```{r set_options, echo=FALSE, cache=FALSE}
options(width = 100)
```

***

[__Mark D. Scheuerell__](https://faculty.washington.edu/scheuerl/)  
_Fish Ecology Division, Northwest Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, Seattle, WA USA, <mark.scheuerell@noaa.gov>_

### Version

This is version `r paste0('0.',format(Sys.time(), '%y.%m.%d'))`.

***

# Initialization

```{r load_pkgs, message=FALSE}
library(readr)
library(reshape2)
library(MARSS)
```

# Data

For these analyses we will use time series of counts of adult spring/summer Chinook salmon from the Snake River basin in Oregon and Idaho. This group of fish forms an Evolutionarily Significant Unit, which was listed as threatened under the US Endangered Species Act in 1992.

The data were compiled largely through the efforts of Tom Cooney (Northwest Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, Portland, OR USA, <tom.cooney@noaa.gov>).

## Assets

The assets data file has the following columns of information:

* `pop` = abbreviated name of the population
* `code` = 5-letter abbreviation for MPG (2 letters) & population (3 letters)
* `mpg` = name of 1 of 5 Major Population Groups
* `ha` = estimated area (hectares) of available spawning habitat
* `category` = hatchery supplementation category ("impact" or "control")
* `brood_yr` = year when spawning occurred  
* `nS` = total number of spawning fish
* `phos` = proportion of hatchery-origin spawners

```{r read_data, collapse=TRUE}
rawdata <- read.csv("https://raw.githubusercontent.com/mdscheuerell/CAPM/master/data/srss_chin.csv")
head(rawdata)
```

The first thing to do is remove hatchery-origin spawners from the counts, and then convert the counts to log-density based on the estimated spawning area for each population.

```{r get_wild_density}
dat <- rawdata[,c("mpg", "code", "pop", "category", "brood_yr")]
dat$Sw <- round(log(rawdata$nS*(1-rawdata$phos)/rawdata$ha), 2)
```

For easier bookkeeping, I'll also switch the Imnaha's MPG over to the Grande Ronde.

```{r mpg_change}
## change Imnaha name for easier sorting later
dat[,"code"] <- sub("IRMAI", "GR_IR", dat[,"code"], fixed=TRUE)
```

Only a few of the populations have observations going all the way back to the 1950s, so I'll trim the data accordingly.

```{r, trim_years}
## first brood year to consider
yr_first <- 1960
## last brood year to consider
yr_last <- 2011
## years of interest
t_index <- seq(yr_first, yr_last)
## length of time period
TT <- length(t_index)
## subset data
dat <- subset(dat, brood_yr>=yr_first & brood_yr<=yr_last)
```

Finally, we will use the `MARSS` package to fit the CAPM model, and it requires the data as an [N x T] matrix.

```{r get_assets}
assets <- t(dcast(dat, brood_yr ~ code, value.var="Sw")[,-1])
```

## Market index

The first "market"" index is based on the monthly North Pacific Gyre Oscillation (NPGO) data provided by Emanuele Di Lorenzo, which are available [here](http://www.o3d.org/npgo/npgo.php). We begin by downloading the raw NPGO data and viewing the metadata.

```{r get_NPGO_metadata}
## URL for NPGO data
url_NPGO <- "http://www.o3d.org/npgo/npgo.php"
## raw NPGO data 
NPGO_raw <- read_lines(url_NPGO)
## line with data headers
hdr_NPGO <- which(lapply(NPGO_raw,grep,pattern="YEAR")==1, arr.ind=TRUE)
## print PDO metadata
print(NPGO_raw[seq(hdr_NPGO)],quote=FALSE)
```

Next, we will extract the actual NPGO indices for the years of interest and inspect the file contents. We also want the average annual NPGO index from January 1 through December 31 during the first year that the juvenile salmon are in the ocean (i.e., during their second year of life). Therefore, we need NPGO values from `yr_first + 2` = `r yr_first + 2` through `yr_last + 2` = `r yr_last + 2`.

```{r get_NPGO, message=FALSE}
## NPGO data for years of interest
dat_NPGO <- read_table(url_NPGO, col_names = FALSE, skip=hdr_NPGO + (yr_first+2-1950)*12, n_max = TT*12)
colnames(dat_NPGO) <- c("year","month","NPGO")
## calculate annual means
market <- aggregate(dat_NPGO$NPGO, by = list(year = dat_NPGO$year), FUN = mean)
colnames(market) <- c("brood_yr", "NPGO")
## match calendar yr to brood year
market$brood_yr <- market$brood_yr - 2
## round NPGO values
market$NPGO <- round(market$NPGO, 3)
market
```

## Risk-free index

For these purposes, the risk free index is zero for all years. The idea is that any population with a standardized return of zero is replacing itself and therefore not declining.

```{r risk_free}
free <- rep(0, TT)
```




